# Template file for 'cross-riscv64-none-elf-gcc'
_triplet=riscv64-none-elf
pkgname=cross-riscv64-none-elf-gcc
version=13.2.0
revision=1
build_wrksrc=build
build_style=gnu-configure
hostmakedepends="base-devel autoconf automake cross-riscv64-none-elf-binutils bison flex
 perl tar texinfo"
makedepends="gmp-devel isl15-devel libmpc-devel mpfr-devel zlib-devel"
depends="cross-riscv64-none-elf-binutils"
short_desc="GNU Compiler Collection for RV32 and RV64 bare metal"
maintainer="Mikhail Karpenko <karpenko@fastmail.com>"
license="GFDL-1.2-or-later, GPL-3.0-or-later, LGPL-2.1-or-later"
homepage="https://gcc.gnu.org"
distfiles="${GNU_SITE}/gcc/gcc-${version}/gcc-${version}.tar.xz"
checksum=e275e76442a6067341a27f04c5c6b83d8613144004c0413528863dc6b5c743da
alternatives="riscv64-none-elf:/usr/bin/riscv64-none-elf-cc:/usr/bin/riscv64-none-elf-gcc"
nocross=yes
nopie=yes
nostrip_files="libgcc.a libgcov.a"

post_extract() {
	mkdir -p build
}

pre_configure() {
	export CFLAGS_FOR_TARGET="-g -Os -mcmodel=medany -ffunction-sections -fdata-sections"
	export CXXFLAGS_FOR_TARGET="-g -Os -mcmodel=medany -ffunction-sections -fdata-sections"
}

do_configure() {
	../configure \
		--disable-tm-clone-registry \
		--disable-decimal-float \
		--disable-libffi \
		--disable-libgomp \
		--disable-libmudflap \
		--disable-libquadmath \
		--disable-libssp \
		--disable-libstdcxx-pch \
		--disable-libstdc__-v3 \
		--disable-nls \
		--disable-shared \
		--disable-threads \
		--enable-tls \
		--disable-werror \
		--enable-languages=c,c++ \
		--enable-multilib \
		--enable-plugins \
		--host=${XBPS_CROSS_TRIPLET} \
		--libdir=/usr/lib \
		--libexecdir=/usr/lib \
		--prefix=/usr \
		--target=${_triplet} \
		--with-gnu-as \
		--with-gnu-ld \
		--with-host-libstdcxx='-static-libgcc -Wl,-Bstatic,-lstdc++,-Bdynamic -lm' \
		--with-gmp \
		--with-isl \
		--with-mpc \
		--with-mpfr \
		--with-libelf \
		--with-arch=rv64imafdc \
		--with-abi=lp64d \
		--with-native-system-header-dir=/include \
		--with-sysroot=/usr/${_triplet} \
		--with-newlib \
		--with-system-zlib
}

post_install() {
	# Remove documents conflicting with host version
	rm -fr ${DESTDIR}/usr/share/{info,man/man7}
	rm -fr ${DESTDIR}/usr/lib/libcc1.*
}
